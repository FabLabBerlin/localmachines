OpenLayers.Layer.HeatCanvas=OpenLayers.Class(OpenLayers.Layer,{isBaseLayer:!1,heatmap:null,data:[],initialize:function(a,b,c,d){OpenLayers.Layer.prototype.initialize.apply(this,[a,c]),this.setMap(b),this.heatCanvasOptions=d,this.initHeatCanvas(this.map,this.heatCanvasOptions),b.events.register("moveend",this,this.redraw)},initHeatCanvas:function(a,b){b=b||{},this._step=b.step||1,this._degree=b.degree||HeatCanvas.LINEAR,this._opacity=b.opacity||.6,this._colorscheme=b.colorscheme||null;var c=document.createElement("div");c.style.cssText="position:absolute;top:0;left:0;border:0",c.style.width=this.map.size.w+"px",c.style.height=this.map.size.h+"px";var d=document.createElement("canvas");d.style.width=this.map.size.w+"px",d.style.height=this.map.size.h+"px",d.width=parseInt(d.style.width),d.height=parseInt(d.style.height),d.style.opacity=this._opacity,c.appendChild(d),this.heatmap=new HeatCanvas(d),this.div.appendChild(c),this._div=c},onMapResize:function(){var a=this.map.getSize();this.heatmap.resize(a.w,a.h)},pushData:function(a,b,c,d){this.data.push({lon:b,lat:a,v:c,user:d})},_resetCanvasPosition:function(){var a=this.map.getExtent(),b=new OpenLayers.LonLat(a.left,a.top),c=this.map.getLayerPxFromLonLat(b);this._div.style.top=c.y+"px",this._div.style.left=c.x+"px"},redraw:function(){this._resetCanvasPosition(),this.heatmap.clear();var a=this.map.getSize();if(this.data.length>0){for(var b=[],c=0,d=this.data.length;d>c;c++){var e=new OpenLayers.LonLat(this.data[c].lon,this.data[c].lat);e=e.transform(this.map.displayProjection,this.map.getProjectionObject());var f=this.map.getViewPortPxFromLonLat(e);0<=f.x&&f.x<=a.w&&0<=f.y&&f.y<=a.h&&b.push(this.data[c]),this.heatmap.push(Math.floor(f.x),Math.floor(f.y),this.data[c].v)}$("#heatmap_users").html(b.map(function(a){return'<a href="/admin/#/users/'+a.user+'">'+a.user+"</a>"}).join("\n")),this.heatmap.render(this._step,this._degree,this._colorscheme)}},afterAdd:function(){},CLASS_NAME:"OpenLayers.Layer.HeatCanvas"});